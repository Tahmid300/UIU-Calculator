<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIU Cybernetic Finance Hub: CGPA & Fee Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom Styles for the Cybernetic Theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary: #f472b6; /* Pink/Fuchsia for primary accent (UIU Secondary color feel) */
            --secondary: #22d3ee; /* Cyan for secondary accent */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e5e7eb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .cyber-card {
            background-color: #161b22; /* Slightly lighter dark background for cards */
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(244, 114, 182, 0.1), 0 0 5px rgba(34, 211, 238, 0.2);
        }

        .neon-text {
            color: var(--primary);
            text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary);
        }

        .neon-button {
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--secondary);
            border: 2px solid var(--secondary);
        }

        .neon-button:hover {
            background-color: var(--secondary);
            color: #161b22;
            box-shadow: 0 0 15px var(--secondary);
            transform: translateY(-2px);
        }

        .fuchsia-bg-button {
            background-color: var(--primary);
            color: #161b22;
            font-weight: 600;
        }

        .fuchsia-bg-button:hover {
            background-color: #ec4899; /* Darker pink on hover */
            box-shadow: 0 0 15px var(--primary);
        }

        .gemini-button {
            background-color: #10b981; /* Emerald Green */
            color: #0d1117;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px #10b981;
        }

        .gemini-button:hover {
             background-color: #059669; /* Darker Green */
             box-shadow: 0 0 15px #10b981;
             transform: translateY(-2px);
        }

        /* Responsive Grid for Courses */
        .course-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 0.5fr; /* Label | Credit | Grade | Remove */
            gap: 1rem;
            align-items: center;
        }

        .retake-grid {
            grid-template-columns: 1fr 1fr 1fr 0.5fr; /* Credit | Old Grade | New Grade | Remove */
        }

        @media (max-width: 768px) {
            .course-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .retake-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            .retake-grid .credit-select { grid-column: 1 / span 2; }
            .retake-grid .remove-btn { grid-column: 2; }
        }

        /* Inputs and Selects Styling */
        input[type="number"], select, textarea {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #e5e7eb;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 5px rgba(34, 211, 238, 0.5);
        }

        /* Radio Group Styling (Hidden native, styled custom) */
        .radio-container input[type="radio"] {
            display: none;
        }

        .radio-custom-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            border: 2px solid #4b5563;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #1f2937;
        }

        .radio-container input[type="radio"]:checked + .radio-custom-label {
            border-color: var(--primary);
            background-color: rgba(244, 114, 182, 0.2);
            color: var(--primary);
            box-shadow: 0 0 8px rgba(244, 114, 182, 0.5);
        }

    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 w-full flex flex-col items-center">

        <!-- Header/Title -->
        <header class="w-full text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">
                <span class="neon-text">U</span>IU <span class="neon-text">A</span>cademic <span class="neon-text">H</span>ub
            </h1>
            <p class="text-gray-400 mt-2 text-lg">United International University (UIU) CGPA & Fee Matrix</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="w-full max-w-2xl mx-auto mb-8 bg-gray-800 p-1 rounded-xl shadow-lg border border-gray-700">
            <div class="flex justify-around space-x-4">
                <button id="tab-cgpa" class="flex-1 px-4 py-3 rounded-xl text-lg font-semibold transition duration-300 transform scale-105" data-tab="cgpa">
                    <i data-lucide="graduation-cap" class="inline w-5 h-5 mr-2"></i> CGPA Reactor
                </button>
                <button id="tab-fees" class="flex-1 px-4 py-3 rounded-xl text-lg font-semibold text-gray-400 hover:text-white transition duration-300" data-tab="fees">
                    <i data-lucide="banknote" class="inline w-5 h-5 mr-2"></i> Fee Matrix
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="w-full">
            <!-- CGPA Calculator Section (Tab 1) -->
            <div id="content-cgpa" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Calculator Inputs -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="cyber-card p-6 rounded-xl space-y-4">
                            <h2 class="text-xl font-bold border-b border-fuchsia-400/30 pb-3">Baseline Parameters</h2>
                            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                                <input id="completed-credits" type="number" placeholder="Completed Credits (e.g., 60)" class="w-full p-3 rounded-lg">
                                <input id="current-cgpa" type="number" step="0.01" placeholder="Current CGPA (e.g., 3.50)" class="w-full p-3 rounded-lg">
                            </div>
                        </div>

                        <!-- Dynamic Courses Section -->
                        <div class="cyber-card p-6 rounded-xl">
                            <h2 class="text-xl font-bold border-b border-fuchsia-400/30 pb-3 mb-4">Current Trimester Courses</h2>
                            <div id="courses-container" class="space-y-4">
                                <!-- Dynamic rows will be inserted here -->
                            </div>
                            
                            <div class="flex flex-wrap gap-4 mt-6">
                                <button id="add-more-btn" class="flex-1 neon-button px-4 py-2 rounded-lg flex items-center justify-center text-sm">
                                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add Course
                                </button>
                                <button id="retake-btn" class="flex-1 neon-button px-4 py-2 rounded-lg flex items-center justify-center text-sm">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></i> Add Retake Course
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-4">
                            <button id="reset-btn" class="flex-1 px-6 py-3 rounded-lg text-gray-400 border border-gray-600 hover:bg-gray-700 transition duration-300">
                                <i data-lucide="refresh-ccw" class="inline w-4 h-4 mr-2"></i> RESET
                            </button>
                            <button id="calculate-cgpa-btn" class="flex-1 fuchsia-bg-button px-6 py-3 rounded-lg text-lg transition duration-300">
                                <i data-lucide="zap" class="inline w-5 h-5 mr-2"></i> Calculate Final CGPA
                            </button>
                        </div>
                    </div>

                    <!-- Grading Policy & Results -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="cyber-card p-6 rounded-xl sticky top-8">
                            <h2 class="text-xl font-bold mb-4 text-cyan-400">CGPA Results</h2>
                            <div id="cgpa-results" class="space-y-3 text-lg">
                                <p class="flex justify-between items-center border-b border-gray-700 pb-2">
                                    <span class="text-gray-400">Semester GPA:</span>
                                    <span id="result-semester-gpa" class="font-bold text-cyan-400">--</span>
                                </p>
                                <p class="flex justify-between items-center border-b border-gray-700 pb-2">
                                    <span class="text-gray-400">Total Credits:</span>
                                    <span id="result-total-credits" class="font-bold">--</span>
                                </p>
                                <p class="flex justify-between items-center pt-2">
                                    <span class="text-gray-300 text-xl">Final Projected CGPA:</span>
                                    <span id="result-final-cgpa" class="text-3xl font-extrabold neon-text">--</span>
                                </p>
                            </div>
                            
                            <!-- LLM Feature 1: Grade Goal Setter -->
                            <h2 class="text-xl font-bold mt-8 mb-4 border-b border-green-500/30 pb-3 text-green-400">
                                Grade Goal Setter ✨
                            </h2>
                            <button id="generate-goals-btn" class="w-full gemini-button px-4 py-2 rounded-lg flex items-center justify-center text-sm">
                                <i data-lucide="cpu" class="w-4 h-4 mr-1"></i> Generate Goal Recommendations
                            </button>
                            <div id="goal-output" class="mt-4 p-4 text-sm bg-gray-800 rounded-lg hidden">
                                <p id="goal-loading" class="text-yellow-400 hidden flex items-center">
                                    <i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Analyzing academic trajectory...
                                </p>
                                <textarea id="goal-textarea" rows="8" class="w-full mt-2 p-2 rounded-lg resize-none text-gray-200" readonly>Goal suggestions will appear here.</textarea>
                            </div>
                            
                            <h3 class="text-md font-bold mt-6 mb-2 text-gray-400">University Grading System</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm rounded-lg overflow-hidden">
                                    <thead class="bg-fuchsia-600 text-gray-900">
                                        <tr>
                                            <th class="p-2">Grade</th>
                                            <th class="p-2">Point</th>
                                            <th class="p-2">Marks (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-gray-800 text-center">
                                        <tr><td class="p-2 text-cyan-400">A</td><td class="p-2">4.00</td><td class="p-2">90–100</td></tr>
                                        <tr><td class="p-2">A-</td><td class="p-2">3.67</td><td class="p-2">86–89</td></tr>
                                        <tr><td class="p-2">B+</td><td class="p-2">3.33</td><td class="p-2">82–85</td></tr>
                                        <tr><td class="p-2">B</td><td class="p-2">3.00</td><td class="p-2">78–81</td></tr>
                                        <tr><td class="p-2">C</td><td class="p-2">2.00</td><td class="p-2">66–69</td></tr>
                                        <tr><td class="p-2 text-red-400">F</td><td class="p-2">0.00</td><td class="p-2">0–54</td></tr>
                                        <!-- Add more detailed UIU grades here if needed -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tuition Fee Calculator Section (Tab 2) -->
            <div id="content-fees" class="tab-content hidden">
                <div class="space-y-8">
                    <!-- Core Fee Inputs -->
                    <div class="cyber-card p-6 rounded-xl grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="new-credit" type="number" placeholder="New Credits" class="p-3 rounded-lg">
                        <input id="retake-credit" type="number" placeholder="Retake Credits" class="p-3 rounded-lg">
                        <input id="per-credit-fee" type="number" placeholder="Per Credit Fee (Tk)" class="p-3 rounded-lg">
                        <select id="registration-fee" class="p-3 rounded-lg">
                            <option value="" disabled selected>Select Trimester/Semester Fee</option>
                            <option value="5000">Registration Fee: 5000 Tk</option>
                            <option value="6500">Registration Fee: 6500 Tk</option>
                        </select>
                    </div>

                    <!-- Discount and Status Options -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Waiver -->
                        <div class="cyber-card p-5 rounded-xl radio-container">
                            <h3 class="text-lg font-bold mb-3 text-fuchsia-400">Academic Waiver (%)</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="radio" name="waiver" id="waiver-100" value="100" checked><label for="waiver-100" class="radio-custom-label rounded-lg">100%</label>
                                <input type="radio" name="waiver" id="waiver-50" value="50"><label for="waiver-50" class="radio-custom-label rounded-lg">50%</label>
                                <input type="radio" name="waiver" id="waiver-25" value="25"><label for="waiver-25" class="radio-custom-label rounded-lg">25%</label>
                                <input type="radio" name="waiver" id="waiver-0" value="0"><label for="waiver-0" class="radio-custom-label rounded-lg">0%</label>
                            </div>
                        </div>
                        
                        <!-- Scholarship -->
                        <div class="cyber-card p-5 rounded-xl radio-container">
                            <h3 class="text-lg font-bold mb-3 text-cyan-400">Merit Scholarship (%)</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="radio" name="scholarship" id="sch-100" value="100"><label for="sch-100" class="radio-custom-label rounded-lg">100%</label>
                                <input type="radio" name="scholarship" id="sch-50" value="50"><label for="sch-50" class="radio-custom-label rounded-lg">50%</label>
                                <input type="radio" name="scholarship" id="sch-25" value="25"><label for="sch-25" class="radio-custom-label rounded-lg">25%</label>
                                <input type="radio" name="scholarship" id="sch-0" value="0" checked><label for="sch-0" class="radio-custom-label rounded-lg">0%</label>
                            </div>
                        </div>

                        <!-- Late Registration -->
                        <div class="cyber-card p-5 rounded-xl radio-container">
                            <h3 class="text-lg font-bold mb-3 text-gray-300">Late Registration Status</h3>
                            <div class="grid grid-cols-2 gap-3 h-full items-center">
                                <input type="radio" name="late" id="late-yes" value="yes"><label for="late-yes" class="radio-custom-label rounded-lg">YES (+1000 Tk)</label>
                                <input type="radio" name="late" id="late-no" value="no" checked><label for="late-no" class="radio-custom-label rounded-lg">NO</label>
                            </div>
                        </div>
                    </div>

                    <button id="calculate-fee-btn" class="w-full fuchsia-bg-button px-6 py-4 rounded-xl text-xl transition duration-300">
                        <i data-lucide="calculator" class="inline w-6 h-6 mr-2"></i> CALCULATE FEE MATRIX
                    </button>

                    <!-- Results Section -->
                    <div id="fee-results-section" class="hidden">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <!-- Fee Details Table -->
                            <div class="cyber-card p-6 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-cyan-400/30 pb-3 text-cyan-400">Transaction Summary</h3>
                                <table class="w-full text-left">
                                    <tbody id="fee-results-body" class="divide-y divide-gray-700">
                                    </tbody>
                                    <tfoot>
                                        <tr class="text-xl font-bold bg-gray-700/50">
                                            <td class="p-3 rounded-bl-xl">Total Payable Amount</td>
                                            <td id="final-amount" class="p-3 text-right neon-text rounded-br-xl">0.00 Tk</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Installment Breakdown -->
                            <div class="cyber-card p-6 rounded-xl">
                                <h3 class="text-xl font-bold mb-4 border-b border-fuchsia-400/30 pb-3 text-fuchsia-400">Installment Plan (40% / 30% / 30%)</h3>
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-gray-400">
                                            <th class="py-2">Installment</th>
                                            <th class="py-2 text-right">Amount (Tk)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="installment-body" class="divide-y divide-gray-700">
                                        <!-- Installment rows will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- LLM Feature 2: Financial Justification Generator -->
                        <div class="cyber-card p-6 rounded-xl">
                            <h2 class="text-xl font-bold mb-4 border-b border-green-500/30 pb-3 text-green-400">
                                Financial Justification Generator ✨
                            </h2>
                            <textarea id="justification-purpose" rows="2" placeholder="Example: Briefly explain why you need this document (e.g., 'Draft email to parents' or 'Letter to HR for tuition reimbursement')." class="w-full p-3 rounded-lg mb-4"></textarea>
                            <button id="generate-justification-btn" class="w-full gemini-button px-4 py-2 rounded-lg flex items-center justify-center text-sm">
                                <i data-lucide="message-square-text" class="w-4 h-4 mr-1"></i> Generate Justification Document
                            </button>
                            <div id="justification-output" class="mt-4 p-4 text-sm bg-gray-800 rounded-lg hidden">
                                <p id="justification-loading" class="text-yellow-400 hidden flex items-center">
                                    <i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Drafting financial summary...
                                </p>
                                <textarea id="justification-textarea" rows="12" class="w-full mt-2 p-2 rounded-lg resize-none text-gray-200" readonly>Your generated justification will appear here.</textarea>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>

        <!-- Notification/Alert Modal -->
        <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
            <div id="notification-content" class="cyber-card p-8 rounded-xl max-w-sm w-full text-center transform scale-90 transition-transform duration-300">
                <h3 id="notification-title" class="text-2xl font-bold mb-4 neon-text"></h3>
                <p id="notification-message" class="text-gray-300 mb-6"></p>
                <button id="close-notification" class="w-full fuchsia-bg-button px-4 py-2 rounded-lg">
                    Acknowledge
                </button>
            </div>
        </div>
    </div>

    <!-- Footer (new developer credit) -->
    <footer class="mt-auto w-full border-t border-gray-700 bg-gray-900/50 p-6 text-center text-gray-500 text-sm">
        <p>
            Project Developed & Advanced for UIU by: 
            <span class="font-bold text-fuchsia-400">S.M.Tahmid Hasan Shahria</span>
        </p>
        <p class="mt-1">
            <span class="text-cyan-400">251 Batch</span>, CSE Department | Version 2.0 (Cybernetic Edition)
        </p>
    </footer>

    <script>
        // --- API Key and URL for Gemini (gemini-2.5-flash-preview-09-2025) ---
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- Core Application Logic ---

        // State variables
        let courseCount = 0;
        let isRetakeHeaderAdded = false;

        // Utility function for exponential backoff retry logic
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    // If 429 (Too Many Requests), wait with exponential backoff
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Max retries exceeded");
        }


        // Utility to display custom notification/modal (replaces alert())
        function showNotification(title, message) {
            const modal = document.getElementById('notification-modal');
            const content = document.getElementById('notification-content');
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            content.classList.remove('scale-90');
            content.classList.add('scale-100');
        }

        // Closes the notification modal
        document.getElementById('close-notification').addEventListener('click', () => {
            const modal = document.getElementById('notification-modal');
            const content = document.getElementById('notification-content');
            
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-90');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        });
        
        // --- Course Row Templates and UI Logic ---
        function getCourseRowHTML(count) {
            return `
                <div class="course-grid course-row bg-gray-800 p-3 rounded-lg border border-gray-700" data-course-id="${count}">
                    <span class="course-label text-cyan-400 font-semibold">Course ${count}</span>
                    <select class="credit-select p-3 rounded-lg text-sm">
                        <option value="">Credit</option>
                        <option value="1">1.0</option>
                        <option value="2">2.0</option>
                        <option value="3">3.0</option>
                        <option value="4.5">4.5</option>
                    </select>
                    <select class="grade-select p-3 rounded-lg text-sm">
                        <option value="">Grade</option>
                        <option value="4.00">A (4.00)</option>
                        <option value="3.67">A- (3.67)</option>
                        <option value="3.33">B+ (3.33)</option>
                        <option value="3.00">B (3.00)</option>
                        <option value="2.67">B- (2.67)</option>
                        <option value="2.33">C+ (2.33)</option>
                        <option value="2.00">C (2.00)</option>
                        <option value="1.67">C- (1.67)</option>
                        <option value="1.33">D+ (1.33)</option>
                        <option value="1.00">D (1.00)</option>
                        <option value="0.00">F (0.00)</option>
                    </select>
                    <button class="remove-btn text-red-400 hover:text-red-500 p-2 rounded-full transition duration-150">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        }
        
        function getRetakeRowHTML() {
            return `
                <div class="course-grid retake-grid retake-row bg-gray-800 p-3 rounded-lg border border-fuchsia-400/50" data-retake-id="${Date.now()}">
                    <select class="credit-select p-3 rounded-lg text-sm">
                        <option value="">Credit</option>
                        <option value="1">1.0</option>
                        <option value="2">2.0</option>
                        <option value="3">3.0</option>
                        <option value="4.5">4.5</option>
                    </select>
                    <select class="old-grade-select p-3 rounded-lg text-sm">
                        <option value="">Old Grade</option>
                        <option value="3.67">A-</option>
                        <option value="3.33">B+</option>
                        <option value="3.00">B</option>
                        <option value="2.67">B-</option>
                        <option value="2.33">C+</option>
                        <option value="2.00">C</option>
                        <option value="1.67">C-</option>
                        <option value="1.33">D+</option>
                        <option value="1.00">D</option>
                        <option value="0.00">F</option>
                    </select>
                    <select class="grade-select p-3 rounded-lg text-sm">
                        <option value="">New Grade</option>
                        <option value="4.00">A</option>
                        <option value="3.67">A-</option>
                        <option value="3.33">B+</option>
                        <option value="3.00">B</option>
                        <option value="2.67">B-</option>
                        <option value="2.33">C+</option>
                        <option value="2.00">C</option>
                        <option value="1.67">C-</option>
                        <option value="1.33">D+</option>
                        <option value="1.00">D</option>
                        <option value="0.00">F</option>
                    </select>
                    <button class="remove-btn text-red-400 hover:text-red-500 p-2 rounded-full transition duration-150">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
        }

        // Updates the course numbers dynamically
        function updateCourseNumbers() {
            const courseLabels = document.querySelectorAll('.course-row:not(.retake-header) .course-label');
            courseLabels.forEach((label, index) => {
                label.textContent = `Course ${index + 1}`;
            });
            courseCount = courseLabels.length;
        }

        // Adds a new course row
        function addCourseRow() {
            courseCount++;
            const coursesContainer = document.getElementById('courses-container');
            const newRow = document.createElement('div');
            newRow.innerHTML = getCourseRowHTML(courseCount);
            coursesContainer.appendChild(newRow.firstChild);
            
            // Re-initialize Lucide icons for the new row
            lucide.createIcons();
            
            // Attach remove listener
            newRow.querySelector('.remove-btn').addEventListener('click', function() {
                this.closest('.course-row').remove();
                updateCourseNumbers();
            });
        }
        
        // Adds a new retake course row
        function addRetakeRow() {
            const coursesContainer = document.getElementById('courses-container');
            
            if (!isRetakeHeaderAdded) {
                const header = document.createElement('div');
                header.className = 'retake-header text-fuchsia-400 font-bold mt-4 pt-4 border-t border-fuchsia-400/50 course-grid retake-grid';
                header.innerHTML = '<span class="text-center">Credit</span><span class="text-center">Old Grade</span><span class="text-center">New Grade</span><span></span>';
                coursesContainer.appendChild(header);
                isRetakeHeaderAdded = true;
            }

            const newRow = document.createElement('div');
            newRow.innerHTML = getRetakeRowHTML();
            coursesContainer.appendChild(newRow.firstChild);
            
            // Re-initialize Lucide icons for the new row
            lucide.createIcons();

            // Attach remove listener
            newRow.querySelector('.remove-btn').addEventListener('click', function() {
                this.closest('.retake-row').remove();
                
                // Check if the header should be removed
                const remainingRetakes = document.querySelectorAll('.retake-row').length;
                const remainingHeader = document.querySelector('.retake-header');
                
                if (remainingRetakes === 0 && remainingHeader) {
                    remainingHeader.remove();
                    isRetakeHeaderAdded = false;
                }
            });
        }
        
        // --- CGPA Calculation Logic ---
        function calculateCGPA() {
            const completedCredits = parseFloat(document.getElementById('completed-credits').value) || 0;
            const currentCGPA = parseFloat(document.getElementById('current-cgpa').value) || 0;

            if (isNaN(completedCredits) || completedCredits < 0) {
                showNotification('Input Error', 'Please enter a valid number for Completed Credits.');
                return { success: false };
            }
            if (isNaN(currentCGPA) || currentCGPA < 0 || currentCGPA > 4.5) {
                showNotification('Input Error', 'Please enter a valid Current CGPA (0.00 to 4.50).');
                return { success: false };
            }

            let totalPoints = completedCredits * currentCGPA;
            let totalCredits = completedCredits;
            let semesterCredits = 0;
            let semesterPoints = 0;
            let currentCoursesCount = 0;

            // 1. Calculate regular courses
            const regularCourses = document.querySelectorAll('.course-row:not(.retake-row)');
            
            regularCourses.forEach(row => {
                const credit = parseFloat(row.querySelector('.credit-select').value) || 0;
                // Note: We use 0 if grade is empty for projection purposes, but only count if credit > 0
                const grade = parseFloat(row.querySelector('.grade-select').value) || 0; 
                
                if (credit > 0) {
                    totalCredits += credit;
                    totalPoints += (credit * grade);
                    semesterCredits += credit;
                    semesterPoints += (credit * grade);
                    currentCoursesCount++;
                }
            });

            // 2. Calculate retake courses
            const retakeCourses = document.querySelectorAll('.retake-row');
            
            retakeCourses.forEach(row => {
                const credit = parseFloat(row.querySelector('.credit-select').value) || 0;
                const oldGrade = parseFloat(row.querySelector('.old-grade-select').value) || 0;
                const newGrade = parseFloat(row.querySelector('.grade-select').value) || 0; // Use 0 for projection
                
                if (credit > 0) {
                    // Update total points: subtract old points, add new points
                    totalPoints = totalPoints - (credit * oldGrade) + (credit * newGrade);
                    
                    // Count towards semester points (as new grade is earned this semester)
                    semesterCredits += credit;
                    semesterPoints += (credit * newGrade);
                    currentCoursesCount++;
                }
            });

            if (totalCredits === completedCredits && semesterCredits === 0) {
                showNotification('Calculation Required', 'Please add at least one course with valid credit and grade.');
                return { success: false };
            }

            // Final results
            const finalCGPA = totalCredits > 0 ? (totalPoints / totalCredits) : 0;
            const semesterGPA = semesterCredits > 0 ? (semesterPoints / semesterCredits) : 0;
            
            // Display results
            document.getElementById('result-semester-gpa').textContent = semesterGPA.toFixed(2);
            document.getElementById('result-total-credits').textContent = totalCredits.toFixed(2);
            document.getElementById('result-final-cgpa').textContent = finalCGPA.toFixed(2);

            return {
                success: true,
                currentCGPA: currentCGPA.toFixed(2),
                completedCredits: completedCredits.toFixed(2),
                semesterCredits: semesterCredits.toFixed(2),
                currentCoursesCount: currentCoursesCount
            };
        }

        // --- Tuition Fee Calculation Logic ---
        function calculateFee() {
            const newCredit = parseFloat(document.getElementById('new-credit').value) || 0;
            const retakeCredit = parseFloat(document.getElementById('retake-credit').value) || 0;
            const perCreditFee = parseFloat(document.getElementById('per-credit-fee').value) || 0;
            const registrationFeeSelect = document.getElementById('registration-fee');
            const registrationFee = parseFloat(registrationFeeSelect.value) || 0;
            
            const waiver = parseFloat(document.querySelector('input[name="waiver"]:checked')?.value) || 0;
            const scholarship = parseFloat(document.querySelector('input[name="scholarship"]:checked')?.value) || 0;
            const isLateRegistration = document.querySelector('input[name="late"]:checked')?.value === 'yes';

            if (newCredit === 0 && retakeCredit === 0) {
                showNotification('Input Required', 'Please enter New Credit or Retake Credit.');
                return { success: false };
            }
            if (perCreditFee === 0) {
                showNotification('Input Required', 'Please enter the Per Credit Fee.');
                return { success: false };
            }
            if (registrationFee === 0) {
                 showNotification('Input Required', 'Please select a Trimester/Semester Fee.');
                return { success: false };
            }

            // 1. Calculate Base Fees
            const newCreditFee = newCredit * perCreditFee;
            // Retake has a 50% discount on credit fee
            const retakeCreditFeeFull = retakeCredit * perCreditFee;
            const retakeCreditFeeDiscounted = retakeCreditFeeFull * 0.5;
            
            // 2. Determine Max Discount
            const discountPercentage = Math.max(waiver, scholarship);
            const discountType = waiver >= scholarship ? 'Waiver' : 'Scholarship';
            
            // Discount applies only to the new credit fee portion
            const discountAmount = (newCreditFee * discountPercentage) / 100; 

            // 3. Add Fixed Fees
            const lateRegistrationFee = isLateRegistration ? 1000 : 0;
            
            // 4. Calculate Final Payable Amount
            // Payable = (New Credit Fee - Discount) + Discounted Retake Fee + Fixed Fees (Reg + Late)
            const finalCreditFeeAfterDiscount = (newCreditFee - discountAmount) + retakeCreditFeeDiscounted;
            const finalAmount = finalCreditFeeAfterDiscount + registrationFee + lateRegistrationFee;

            // --- Display Results (HTML) ---
            const resultsBody = document.getElementById('fee-results-body');
            const finalAmountCell = document.getElementById('final-amount');
            resultsBody.innerHTML = ''; 

            // Helper to add row
            const addRow = (label, amount, isDeduction = false, isFee = false) => {
                const row = document.createElement('tr');
                row.className = isDeduction ? 'text-red-400' : (isFee ? 'text-cyan-400 font-medium' : 'text-gray-300');
                row.innerHTML = `
                    <td class="p-3">${label}</td>
                    <td class="p-3 text-right">${isDeduction ? '- ' : ''}${Math.abs(amount).toFixed(2)} Tk</td>
                `;
                resultsBody.appendChild(row);
            };

            // A. Base Fees
            addRow(`New Credit Fee (${newCredit.toFixed(1)} Cr)`, newCreditFee, false, true);
            if (retakeCredit > 0) {
                addRow(`Base Retake Fee (${retakeCredit.toFixed(1)} Cr)`, retakeCreditFeeFull, false, true);
                addRow('Retake Discount (50% Off)', retakeCreditFeeFull - retakeCreditFeeDiscounted, true);
            }
            addRow('Registration/Trimester Fee', registrationFee, false, true);
            
            // B. Discounts
            if (discountPercentage > 0) {
                addRow(`${discountType} Discount (${discountPercentage}%)`, discountAmount, true);
            }

            // C. Penalties/Other
            if (isLateRegistration) {
                addRow('Late Registration Fee', lateRegistrationFee, false, true);
            }

            // Final total
            finalAmountCell.textContent = `${finalAmount.toFixed(2)} Tk`;
            
            // --- Installment Breakdown (HTML) ---
            const installmentBody = document.getElementById('installment-body');
            installmentBody.innerHTML = '';
            
            const installments = [
                { name: '1st Installment (40%)', percentage: 40 },
                { name: '2nd Installment (30%)', percentage: 30 },
                { name: '3rd Installment (30%)', percentage: 30 }
            ];
            
            installments.forEach((installment, index) => {
                const amount = (finalAmount * installment.percentage) / 100;
                const row = document.createElement('tr');
                row.className = index === 0 ? 'text-fuchsia-400 font-semibold' : 'text-gray-300';
                row.innerHTML = `
                    <td class="py-3">${installment.name}</td>
                    <td class="py-3 text-right">${amount.toFixed(2)} Tk</td>
                `;
                installmentBody.appendChild(row);
            });
            
            // Show results section
            document.getElementById('fee-results-section').classList.remove('hidden');

            return {
                success: true,
                finalAmount: finalAmount.toFixed(2),
                newCredit: newCredit.toFixed(1),
                retakeCredit: retakeCredit.toFixed(1),
                perCreditFee: perCreditFee.toFixed(2),
                registrationFee: registrationFee.toFixed(2),
                discountPercentage,
                discountType
            };
        }

        // --- LLM Feature 1: Grade Goal Setter ---
        async function generateGradeGoals() {
            const result = calculateCGPA();
            if (!result.success) return;

            const { currentCGPA, completedCredits, semesterCredits, currentCoursesCount } = result;

            if (semesterCredits === '0.00' || currentCoursesCount === 0) {
                 showNotification('Goal Setting Error', 'Please add your planned courses (credits) for this trimester before generating goals.');
                 return;
            }

            const outputDiv = document.getElementById('goal-output');
            const loadingIndicator = document.getElementById('goal-loading');
            const textarea = document.getElementById('goal-textarea');
            const button = document.getElementById('generate-goals-btn');

            outputDiv.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            textarea.value = '';
            button.disabled = true;

            const userQuery = `
                I am a student at UIU. My current CGPA is ${currentCGPA} based on ${completedCredits} completed credits.
                I am taking ${currentCoursesCount} courses this trimester, totaling ${semesterCredits} credits.
                Provide an inspiring but realistic recommendation for the minimum required Semester GPA (SGPA) I should aim for, and a challenging SGPA goal.
                Then, break down these SGPA goals into specific minimum target grades (A, A-, B+, B, C, etc.) for a hypothetical ${currentCoursesCount} courses (assuming each course is 3.0 credits for simplicity, if credits vary).
                Focus on two scenarios:
                1. Minimum Acceptable Target: Achieve an overall CGPA of ${Math.min(parseFloat(currentCGPA) + 0.1, 4.0).toFixed(2)}.
                2. Stretch Target: Achieve an overall CGPA of ${Math.min(parseFloat(currentCGPA) + 0.2, 4.0).toFixed(2)}.
                Present the answer clearly and concisely in bullet points or short paragraphs. Do not use markdown for formatting tables or bullet points.
            `;
            
            const systemPrompt = "You are an AI Academic Advisor for UIU students. Your task is to provide clear, motivating, and mathematically sound academic goal recommendations based on the student's input CGPA and current course load. The output must be concise and encouraging.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not retrieve goal recommendations.";
                
                textarea.value = text.trim();

            } catch (error) {
                textarea.value = `Error generating goals: ${error.message}. Please check your connection or try again later.`;
            } finally {
                loadingIndicator.classList.add('hidden');
                button.disabled = false;
            }
        }

        // --- LLM Feature 2: Financial Justification Generator ---
        async function generateFinancialJustification() {
            const feeResult = calculateFee();
            if (!feeResult.success) return;

            const { finalAmount, newCredit, retakeCredit, perCreditFee, registrationFee, discountPercentage, discountType } = feeResult;
            const purpose = document.getElementById('justification-purpose').value.trim();

            if (!purpose) {
                showNotification('Input Required', 'Please describe the purpose of the justification (e.g., "Email to parents").');
                return;
            }

            const outputDiv = document.getElementById('justification-output');
            const loadingIndicator = document.getElementById('justification-loading');
            const textarea = document.getElementById('justification-textarea');
            const button = document.getElementById('generate-justification-btn');

            outputDiv.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            textarea.value = '';
            button.disabled = true;

            const feeDetails = `
                - Total Payable: ${finalAmount} Tk
                - New Credits: ${newCredit}
                - Retake Credits: ${retakeCredit}
                - Per Credit Fee: ${perCreditFee} Tk
                - Registration Fee: ${registrationFee} Tk
                - Discount/Waiver: ${discountPercentage}% (${discountType})
            `;
            
            const userQuery = `
                I need to draft a document for the following purpose: "${purpose}".
                The document must use the following calculated UIU tuition fee details:
                ${feeDetails}
                Draft a professional and persuasive document (e.g., email or letter, depending on the purpose) that clearly explains the total cost, the breakdown of fees, and highlights any discounts/waivers received. Keep the tone appropriate for the stated purpose. Do not use markdown for formatting tables or bullet points.
            `;
            
            const systemPrompt = "You are an AI Financial Assistant. Your task is to generate professional, accurate, and context-appropriate justification documents based on the provided fee data and stated purpose. Start directly with the draft.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not retrieve financial justification.";
                
                textarea.value = text.trim();

            } catch (error) {
                textarea.value = `Error generating justification: ${error.message}. Please check your connection or try again later.`;
            } finally {
                loadingIndicator.classList.add('hidden');
                button.disabled = false;
            }
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initial call to add the first course row
            addCourseRow(); 

            // 1. Tab Switching Logic
            const tabButtons = document.querySelectorAll('nav button');
            const tabContents = document.querySelectorAll('.tab-content');

            function switchTab(targetTab) {
                tabButtons.forEach(button => {
                    button.classList.remove('scale-105', 'bg-fuchsia-600', 'text-gray-900', 'hover:text-white', 'text-gray-400');
                    button.classList.add('text-gray-400', 'hover:text-white');
                });

                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });

                const activeContent = document.getElementById(`content-${targetTab}`);
                const activeButton = document.getElementById(`tab-${targetTab}`);

                activeContent.classList.remove('hidden');
                activeButton.classList.add('scale-105', 'bg-fuchsia-600', 'text-gray-900');
                activeButton.classList.remove('text-gray-400', 'hover:text-white');
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            
            // Set initial active tab
            switchTab('cgpa'); 
            
            // 2. CGPA Listeners
            document.getElementById('add-more-btn').addEventListener('click', addCourseRow);
            document.getElementById('retake-btn').addEventListener('click', addRetakeRow);
            document.getElementById('calculate-cgpa-btn').addEventListener('click', calculateCGPA);
            document.getElementById('generate-goals-btn').addEventListener('click', generateGradeGoals); // New LLM Button

            document.getElementById('reset-btn').addEventListener('click', function() {
                // Clear inputs
                document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                
                // Clear selections
                document.querySelectorAll('select').forEach(select => select.value = '');
                
                // Clear LLM outputs
                document.getElementById('goal-textarea').value = 'Goal suggestions will appear here.';
                document.getElementById('justification-textarea').value = 'Your generated justification will appear here.';
                document.getElementById('justification-purpose').value = '';


                // Reset dynamic rows
                const coursesContainer = document.getElementById('courses-container');
                coursesContainer.innerHTML = ''; // Clear all
                isRetakeHeaderAdded = false;
                addCourseRow(); // Add back the first course

                // Reset results display
                document.getElementById('result-semester-gpa').textContent = '--';
                document.getElementById('result-total-credits').textContent = '--';
                document.getElementById('result-final-cgpa').textContent = '--';
                document.getElementById('fee-results-section').classList.add('hidden');

                showNotification('System Reset', 'UIU Academic Hub state has been wiped clean.');
            });
            
            // 3. Fee Calculator Listener
            document.getElementById('calculate-fee-btn').addEventListener('click', calculateFee);
            document.getElementById('generate-justification-btn').addEventListener('click', generateFinancialJustification); // New LLM Button


            // Initialize Lucide Icons
            lucide.createIcons();
        });
        
    </script>
</body>
</html>